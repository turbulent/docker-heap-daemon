server_name {{VAR_SSL_SERVER_NAME}}{{ " " ~ VAR_NGINX_SERVER_ALIASES|ensurelist|join(" ") ~ ';' if VAR_NGINX_SERVER_ALIASES else ";" }}

{%- if VAR_NGINX_LOADBALANCER_IPS|ensurelist|length %}
real_ip_header {{VAR_NGINX_LOADBALANCER_HEADER|default('X-Real-IP')}};
{%- for lbip in VAR_NGINX_LOADBALANCER_IPS|ensurelist %}
set_real_ip_from {{lbip}};
{%- endfor %}
{%- endif %}

client_max_body_size {{VAR_NGINX_MAX_BODY_SIZE}};
proxy_read_timeout {{VAR_NGINX_PROXY_READ_TIMEOUT}};
proxy_send_timeout {{VAR_NGINX_PROXY_SEND_TIMEOUT}};
proxy_cache off;
proxy_redirect  off;
proxy_buffering off;
access_log off;

proxy_set_header   Host             $host;
proxy_set_header   X-Real-IP        $remote_addr;
proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
proxy_pass_header Expires;
proxy_pass_header Cache-Control;
proxy_pass_header Last-Modified;
proxy_pass_header ETag;
proxy_pass_header Content-Length;

location / {
  proxy_pass http://wsbackend;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}

location ~ (\.svn|\.git|\.php|\.gitignore|\.sql|\.sh|\.conf|\.htaccess)$ { deny all; break; }
location ~ /\. { access_log off; log_not_found off; deny all; }

{%- if VAR_NGINX_EXTRACONF %}
include {{VAR_NGINX_EXTRACONF}};
{%- endif %}